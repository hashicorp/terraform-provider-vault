name: Build

on: push

jobs:
  container-job:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: true
      matrix:
        image: ["hashicorp/vault-enterprise:1.10-ent", "hashicorp/vault-enterprise:1.9-ent"]
    container:
      image: docker.mirror.hashicorp.services/golang:1.17.10
    services:
      vault:
        image: ${{ matrix.image }}
        env:
          VAULT_DEV_ROOT_TOKEN_ID: root
          VAULT_LICENSE: ${{ secrets.VAULT_LICENSE }}
      mysql:
        image: mysql:latest
        env:
          MYSQL_ROOT_PASSWORD: mysql
      mssql:
        image: mcr.microsoft.com/mssql/server:2017-latest-ubuntu
        env:
          ACCEPT_EULA: Y
          SA_PASSWORD: ${{ secrets.MSSQL_SA_PASSWORD }}
    steps:
      - name: Tune Vault Quotas
        env:
          VAULT_TOKEN: "root"
          VAULT_ADDR: "http://vault:8200"
        run: |
          cat > /tmp/payload.json <<HERE
          {
            "rate_limit_exempt_paths": [
              "auth/token/create"
            ]
          }
          HERE

          curl --fail --show-error --silent \
          --request POST \
          --header "X-Vault-Token: ${VAULT_TOKEN}" \
          --data @/tmp/payload.json \
          ${VAULT_ADDR}/v1/sys/quotas/config
          rm -f /tmp/payload.json
      - uses: actions/checkout@v3
      - name: Build
        run: |
          make build
      - name: Unit Tests
        run: |
          make test TESTARGS='-v'
      - name: Acceptance Tests
        env:
          VAULT_TOKEN: "root"
          VAULT_ADDR: "http://vault:8200"
          TF_ACC_TERRAFORM_VERSION: "1.0.7"
          MYSQL_URL: "root:mysql@tcp(mysql:3306)/"
          MYSQL_CONNECTION_URL: "{{username}}:{{password}}@tcp(mysql:3306)/"
          MYSQL_CONNECTION_USERNAME: "root"
          MYSQL_CONNECTION_PASSWORD: "mysql"
          # TODO: setup mongodb tests
          #MONGODB_URL: "mongodb://root:mongodb@127.0.0.1:27017/admin?ssl: false"
          MSSQL_URL: "sqlserver://sa:${{ secrets.MSSQL_SA_PASSWORD }}@mssql:1433"
        run: |
          make testacc-ent TESTARGS='-v' SKIP_MSSQL_MULTI_CI=true SKIP_RAFT_TESTS=true
